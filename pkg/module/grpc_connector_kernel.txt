package module

import (
	"fmt"
	"github.com/evanyxw/monster-go/pkg/client"
	"github.com/evanyxw/monster-go/pkg/network"
	"github.com/evanyxw/monster-go/pkg/rpc"
	"github.com/evanyxw/monster-go/pkg/server"
	"sync"
)

type GrpcConnectorKernel struct {
	*client.Client

	RpcAcceptor *rpc.Acceptor
	ID          uint32
	SID         server.ServerID
	wg          sync.WaitGroup
	runStatus   int
	NoWaitStart bool
	msgHandler  MsgHandler
	processor   *network.Processor
}

func NewGrpcConnectorKernel(ip string, port uint32, msgHandler MsgHandler, packerFactory network.PackerFactory,
	options ...ckernelOption) *GrpcConnectorKernel {
	rpcAcceptor := rpc.NewAcceptor(10000)
	processor := network.NewProcessor()
	connector := &GrpcConnectorKernel{
		processor:   processor,
		Client:      client.NewClient(fmt.Sprintf("%s:%d", ip, port), processor, packerFactory),
		RpcAcceptor: rpcAcceptor,
		NoWaitStart: false,
		msgHandler:  msgHandler,
	}
	connector.Client.OnMessageCb = connector.MessageHandler

	for _, fn := range options {
		fn(connector)
	}

	return connector
}

func (c *GrpcConnectorKernel) SetID(id uint32) {
	c.ID = id
	server.ID2Sid(id, &c.SID)
}

func (c *GrpcConnectorKernel) Init(baseModule *BaseModule) bool {
	c.runStatus = ModuleRunStatus_Start
	return true
}

func (c *GrpcConnectorKernel) DoRegister() {
	c.RpcAcceptor.Regist(rpc.RPC_NET_CONNECTED, c.OnRpcNetConnected)
	c.RpcAcceptor.Regist(rpc.RPC_NET_ERROR, c.OnRpcNetError)

	if c.msgHandler != nil {
		c.msgHandler.MsgRegister(c.processor)
	}
}

func (c *GrpcConnectorKernel) DoRun() {
	c.RpcAcceptor.Run()
	c.Client.Run(c.RpcAcceptor)
	c.runStatus = ModuleRunStatus_Running
	c.msgHandler.Start()
}

func (c *GrpcConnectorKernel) DoWaitStart() {

}

func (c *GrpcConnectorKernel) DoRelease() {
	c.Client.OnClose()
}

func (c *GrpcConnectorKernel) Update() {

}

func (c *GrpcConnectorKernel) OnOk() {
	c.msgHandler.OnOk()
}

func (c *GrpcConnectorKernel) OnStartClose() {

}

func (c *GrpcConnectorKernel) DoClose() {

}

func (c *GrpcConnectorKernel) OnStartCheck() int {
	if c.runStatus == ModuleRunStatus_Running {
		return ModuleRunCode_Ok
	}
	return ModuleRunCode_Wait
}

func (c *GrpcConnectorKernel) GetNoWaitStart() bool {
	return c.NoWaitStart
}

func (c *GrpcConnectorKernel) OnCloseCheck() int {
	return 0
}

func (c *GrpcConnectorKernel) GetNPManager() network.INPManager {
	return nil
}

func (c *GrpcConnectorKernel) GetStatus() int {
	return 0
}

func (c *GrpcConnectorKernel) RegisterMsg(msgId uint16, handlerFunc network.HandlerFunc) {
	c.processor.RegisterMsg(msgId, handlerFunc)
}

func (c *GrpcConnectorKernel) MessageHandler(packet *network.Packet) {
	c.processor.MessageHandler(packet)
}

func (c *GrpcConnectorKernel) OnRpcNetAccept(args []interface{}) {

}

func (c *GrpcConnectorKernel) OnRpcNetConnected(args []interface{}) {
	np := args[0].(*network.NetPoint)
	c.msgHandler.OnNetConnected(np)
}

func (c *GrpcConnectorKernel) OnRpcNetError(args []interface{}) {
	//np := args[0].(*network.NetPoint)
	//
	//if c.msgHandler != nil {
	//	c.msgHandler.OnNetError(np, nil)
	//}
	//fmt.Println("GrpcConnectorKernel OnRpcNetError np close")
	//np.Close()

	//fixMe OnRpcNetError 还没做其他处理!!!
	fmt.Println("OnRpcNetError 还没做其他处理!!!")
}

func (c *GrpcConnectorKernel) OnRpcNetClose(args []interface{}) {

}

func (c *GrpcConnectorKernel) OnRpcNetData(args []interface{}) {

}

func (c *GrpcConnectorKernel) OnRpcNetMessage(args []interface{}) {

}
